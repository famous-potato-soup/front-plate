version: 2.1

executors:
  node-js-executor:
    working_directory: ~/front-plate
    docker:
      - image: circleci/node:12.9.1

jobs:
  testing:
    branches:
      only:
        - master
        - develop
    executor: node-js-executor
    steps:
      - checkout

      - restore_cache:
          key: dependency-cache-{{ checksum "yarn.lock" }}

      - run:
          name: install dependencies
          command: |
            yarn
            yarn add codecov

      - save_cache:
          key: dependency-cache-{{ checksum "yarn.lock" }}
          paths:
            - ./node_modules

      - run:
          name: test
          command: yarn test --coverage

      - run:
          name: upload coverage data to codecov
          command: yarn codecov

  linting:
    branches:
      only:
        - master
        - develop
    executor: node-js-executor
    steps:
      - checkout

      - restore_cache:
          key: dependency-cache-{{ checksum "yarn.lock" }}

      - run:
          name: install dependencies
          command: yarn

      - save_cache:
          key: dependency-cache-{{ checksum "yarn.lock" }}
          paths:
            - ./node_modules

      - run:
          name: lint
          command: yarn lint
  deploy:
    branches:
      only:
        - master
    executor: node-js-executor
    steps:
      - checkout

      - restore_cache:
          key: dependency-cache-{{ checksum "yarn.lock" }}

      - run:
          name: install dependencies
          command: yarn

      - save_cache:
          key: dependency-cache-{{ checksum "yarn.lock" }}
          paths:
            - ./node_modules

      - run:
          name: deploy
          command: yarn run deploy


workflows:
  version: 2
  front-plate-workflow:
    jobs:
      - testing
      - linting
      - deploy
